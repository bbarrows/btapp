<!DOCTYPE html>  <html> <head>   <title>plugin.btapp.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="btapp.html">                 btapp.js               </a>                                           <a class="source" href="client.btapp.html">                 client.btapp.js               </a>                                           <a class="source" href="pairing.btapp.html">                 pairing.btapp.js               </a>                                           <a class="source" href="plugin.btapp.html">                 plugin.btapp.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               plugin.btapp.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>(c) 2012 Kyle Graehl / Patrick Williams, BitTorrent Inc.
Btapp may be freely distributed under the MIT license.
For all details and documentation:
http://pwmckenna.github.com/btapp</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">BtappPluginManager</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Avoid DOM collisions by having a ridiculous id.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">pid</span><span class="o">:</span> <span class="s1">&#39;btapp_plugin_&#39;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>All BitTorrent products have this number appended to their window names</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">window_hash</span><span class="o">:</span> <span class="s1">&#39;4823&#39;</span><span class="p">,</span>
	<span class="nx">product</span><span class="o">:</span><span class="s1">&#39;Torque&#39;</span><span class="p">,</span>
	<span class="nx">mime_type</span><span class="o">:</span> <span class="s1">&#39;application/x-bittorrent-torque&#39;</span><span class="p">,</span>

	<span class="nx">loading</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
	<span class="nx">loaded</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
	<span class="nx">visible</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
	<span class="nx">downloading_product</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
	<span class="nx">launched_time</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span>
			<span class="s1">&#39;plugin&#39;</span><span class="p">,</span>
			<span class="s1">&#39;add_plugin&#39;</span><span class="p">,</span>
			<span class="s1">&#39;remove_plugin&#39;</span><span class="p">,</span>
			<span class="s1">&#39;plugin_installed&#39;</span><span class="p">,</span>

			<span class="s1">&#39;torque_install_callback&#39;</span><span class="p">,</span>
			<span class="s1">&#39;torque_running&#39;</span><span class="p">,</span>

			<span class="s1">&#39;load_dialog_dependencies&#39;</span><span class="p">,</span>
			<span class="s1">&#39;show_install_plugin_dialog&#39;</span><span class="p">,</span>
			<span class="s1">&#39;hide_install_plugin_dialog&#39;</span><span class="p">,</span>
			<span class="s1">&#39;install_plugin_dialog_visible&#39;</span><span class="p">,</span>

			<span class="s1">&#39;ensure_torque_running&#39;</span><span class="p">,</span>
			<span class="s1">&#39;ensure_plugin_installed&#39;</span><span class="p">,</span>
			<span class="s1">&#39;ensure_plugin_and_product_available&#39;</span>
		<span class="p">);</span>
		<span class="nx">jQuery</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ensure_plugin_and_product_available</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>Plugin Specific Functionality</h2>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">plugin</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pid</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Add the plugin object to the DOM. This doesn't necessarily mean that
we'll have the functionality. We'll need to check the elements properties
to determine if the browser supports our mime type...if only IE supported
listing the mime types the browser supports</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">add_plugin</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">pid</span><span class="p">).</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">onload</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pid</span> <span class="o">+</span> <span class="s1">&#39;onload&#39;</span><span class="p">;</span>
		<span class="nb">window</span><span class="p">[</span><span class="nx">onload</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">cb</span><span class="p">();</span>
		<span class="p">});</span>
		<span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>			
		<span class="nx">jQuery</span><span class="p">(</span><span class="nx">div</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span><span class="s1">&#39;position&#39;</span><span class="o">:</span><span class="s1">&#39;absolute&#39;</span><span class="p">,</span><span class="s1">&#39;left&#39;</span><span class="o">:</span><span class="s1">&#39;-999em&#39;</span><span class="p">});</span>
		<span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span>
			<span class="s1">&#39;&lt;object id=&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">pid</span> <span class="o">+</span> <span class="s1">&#39;&quot; type=&quot;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">mime_type</span> <span class="o">+</span> <span class="s1">&#39;&quot; width=&quot;0&quot; height=&quot;0&quot;&gt;&#39;</span> <span class="o">+</span>
				<span class="s1">&#39;&lt;param name=&quot;onload&quot; value=&quot;&#39;</span> <span class="o">+</span> <span class="nx">onload</span> <span class="o">+</span> <span class="s1">&#39;&quot; /&gt;&#39;</span> <span class="o">+</span>
			<span class="s1">&#39;&lt;/object&gt;&#39;</span><span class="p">;</span>

		<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
		<span class="nx">setTimeout</span><span class="p">(</span><span class="nb">window</span><span class="p">[</span><span class="nx">onload</span><span class="p">],</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Just blow the DOM element away...it probably means that we discovered
that the mime type wasn't supported and we need to install the plugin.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">remove_plugin</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;#btapp_plugin&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This is a pretty messy way to determine if we have the plugin installed.
Hope this doesn't have a race condition in it.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">plugin_installed</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">plugin</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">add_plugin</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="kd">var</span> <span class="nx">exists</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">plugin</span><span class="p">().</span><span class="nx">version</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">remove_plugin</span><span class="p">();</span>
		<span class="k">return</span> <span class="nx">exists</span><span class="p">;</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h2>Torque Specific Functionality</h2>

<p>This is called when the plugin has downloaded and run the torque client.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">torque_install_callback</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;plugin:torque_installed&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">downloading_product</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">launched_time</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>don't try to re-launch or re-download for a while...
(race condition, it doesn't show up in isRunning for a little while, but we want to be able to detect it right away</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">setTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ensure_plugin_and_product_available</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Lets ask the plugin if the specific client is running.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">torque_running</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">plugin</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plugin</span><span class="p">();</span>
		<span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="nx">plugin</span><span class="p">.</span><span class="nx">isRunning</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">product</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">window_hash</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">running</span> <span class="o">=</span> <span class="nx">clients</span> <span class="o">&amp;&amp;</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="nx">running</span><span class="p">;</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>Dialog specific functionality</h2>

<p>We didn't want to burdon the browser with loading in all the facebox code
if we didn't need it...well here we are.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">load_dialog_dependencies</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">css_link</span> <span class="o">=</span> <span class="s1">&#39;http://apps.bittorrent.com/torque/facebox/src/facebox.css&#39;</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">head</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">);</span>
		<span class="nx">head</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;&#39;</span> <span class="o">+</span> <span class="nx">css_link</span> <span class="o">+</span> <span class="s1">&#39;&quot; /&gt;&#39;</span><span class="p">);</span>
		<span class="nx">jQuery</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span><span class="s1">&#39;http://apps.bittorrent.com/torque/facebox/src/facebox.js&#39;</span><span class="p">,</span>
			<span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
				<span class="nx">jQuery</span><span class="p">.</span><span class="nx">facebox</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">overlay</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// to disable click outside overlay to disable it</span>
				<span class="nx">jQuery</span><span class="p">.</span><span class="nx">facebox</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">closeImage</span> <span class="o">=</span> <span class="s1">&#39;http://apps.bittorrent.com/torque/facebox/src/closelabel.png&#39;</span><span class="p">;</span>
				<span class="nx">jQuery</span><span class="p">.</span><span class="nx">facebox</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">loadingImage</span> <span class="o">=</span> <span class="s1">&#39;http://apps.bittorrent.com/torque/facebox/src/loading.gif&#39;</span><span class="p">;</span>						
				<span class="nx">jQuery</span><span class="p">.</span><span class="nx">facebox</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">;</span>
				<span class="nx">callback</span><span class="p">();</span>
			<span class="p">},</span> <span class="k">this</span><span class="p">)</span>
		<span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Its show time! Lets get this baby installed.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">show_install_plugin_dialog</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;plugin:show_install_plugin_dialog&#39;</span><span class="p">);</span>
		<span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">visible</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">dialog</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;&lt;div&gt;&lt;/div&gt;&#39;</span><span class="p">);</span>
		<span class="nx">dialog</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;install&#39;</span><span class="p">);</span>

		<span class="kd">var</span> <span class="nx">paragraph</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;&lt;p&gt;&lt;/p&gt;&#39;</span><span class="p">);</span>
		<span class="nx">paragraph</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;This site requires the BitTorrent Torque plugin.&#39;</span><span class="p">);</span>
		<span class="nx">dialog</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">paragraph</span><span class="p">);</span>

		<span class="kd">var</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;&lt;a id=&quot;download&quot; href=&quot;http://apps.bittorrent.com/torque/Torque.msi&quot;&gt;Download&lt;/a&gt;&#39;</span><span class="p">);</span>
		<span class="nx">button</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;downloading_plugin&#39;</span><span class="p">));</span>
		<span class="nx">dialog</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">button</span><span class="p">);</span>
		<span class="nx">dialog</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
		<span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">dialog</span><span class="p">);</span>
		<span class="nx">jQuery</span><span class="p">.</span><span class="nx">facebox</span><span class="p">({</span> <span class="nx">div</span><span class="o">:</span> <span class="s1">&#39;#install&#39;</span> <span class="p">});</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Uh oh...this could happen for a million reasons.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">hide_install_plugin_dialog</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">visible</span><span class="p">);</span>
		<span class="nx">jQuery</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;close.facebox&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;plugin:hide_install_plugin_dialog&#39;</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Is the user pondering whether to install?</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">install_plugin_dialog_visible</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">visible</span><span class="p">;</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h2>The Controller Logic</h2>

<p>What to download, what to install, what dialogs to show</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">ensure_torque_running</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">install_plugin_dialog_visible</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">hide_install_plugin_dialog</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">torque_running</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;plugin:torque_running&#39;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">launched_time</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Torque is running. OK! Lets check back again in 10 secs, in case torque crashes or something</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">setTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ensure_plugin_and_product_available</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">downloading_product</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">launched_time</span> <span class="o">&amp;&amp;</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">launched_time</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Allow launch 10 seconds until the process shows up.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="kd">var</span> <span class="nx">switches</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;install&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;plugin:install_torque&#39;</span><span class="p">,</span> <span class="nx">switches</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">switches</span><span class="p">.</span><span class="nx">install</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">downloading_product</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">plugin</span><span class="p">().</span><span class="nx">downloadProgram</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">product</span><span class="p">,</span> <span class="nx">Btapp</span><span class="p">.</span><span class="nx">VERSION</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">torque_install_callback</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>We don't have the plugin and the app that's loaded this file hasn't opted out     // of the install path. Lets offer it up to the user.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">ensure_plugin_installed</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">install_plugin_dialog_visible</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">loaded</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">show_install_plugin_dialog</span><span class="p">();</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">loading</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">load_dialog_dependencies</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">show_install_plugin_dialog</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">remove_plugin</span><span class="p">();</span>
		<span class="nx">setTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ensure_plugin_and_product_available</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>This is the main entry point to this file. We want to install both the plugin and torque and make sure torque is running.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">ensure_plugin_and_product_available</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>If we haven't added the plugin object tag, add it then check back when its loaded</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">plugin</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">add_plugin</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ensure_plugin_and_product_available</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>We use the version property to determine if the plugin has been loaded (indicating mime type support).</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">plugin_installed</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">plugin</span><span class="p">().</span><span class="nx">version</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">plugin_installed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;plugin:plugin_running&#39;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">ensure_torque_running</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">switches</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;install&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;plugin:install_plugin&#39;</span><span class="p">,</span> <span class="nx">switches</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">switches</span><span class="p">.</span><span class="nx">install</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">ensure_plugin_installed</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>	
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 