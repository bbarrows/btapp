<!DOCTYPE html>  <html> <head>   <title>client.btapp.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="btapp.html">                 btapp.js               </a>                                           <a class="source" href="client.btapp.html">                 client.btapp.js               </a>                                           <a class="source" href="pairing.btapp.html">                 pairing.btapp.js               </a>                                           <a class="source" href="plugin.btapp.html">                 plugin.btapp.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               client.btapp.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>(c) 2012 Patrick Williams, BitTorrent Inc.
Btapp may be freely distributed under the MIT license.
For all details and documentation:
http://pwmckenna.github.com/btapp</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Torrent Client (base functionality for Falcon/Local Torrent Clients)</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>TorrentClient provides a very thin wrapper around the web api
It should facilitate finding the correct port and connecting if
necessary to the user computer through falcon...by default uses localhost</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>TorrentClient is responsible for the mapping between functions
passed to as arguments and the string that proxies them to the client</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>TorrentClient is responsible for creating functions that wrap around
specific urls that can can be dangled off of models so that when we call
stop on a torrent file, the torrent specific url is accessed without any
effort on the part of the client</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Keep in mind that because jsonp won't time out naturally, we impose our own
timeouts...this can lead to some less than desirable code :(</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">TorrentClient</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">btappCallbacks</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>We can't send function pointers to the torrent client server, so we'll send
the name of the callback, and the server can call this by sending an event with
the name and args back to us. We're responsible for making the call to the function
when we detect this. This is the same way that jquery handles ajax callbacks.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">storeCallbackFunction</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">cb</span> <span class="o">=</span> <span class="nx">cb</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
		<span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="s1">&#39;bt_&#39;</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">||</span> <span class="p">(</span><span class="nx">str</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">btappCallbacks</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="nx">str</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span> <span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">btappCallbacks</span><span class="p">[</span><span class="nx">str</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">;</span>
		<span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>We expect function signatures that come from the client to have a specific syntax</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">isFunctionSignature</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">f</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\[native function\](\([^\)]*\))+/</span><span class="p">)</span> <span class="o">||</span>
				<span class="nx">f</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\[nf\](\([^\)]*\))+/</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Seeing as we're interfacing with a strongly typed language c/c++ we need to
ensure that our types are at least close enough to coherse into the desired types
takes something along the lines of "<a href="string,unknown">native function</a>(string)".</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">validateArguments</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">functionValue</span><span class="p">,</span> <span class="nx">variables</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">functionValue</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;expected functionValue to be a string&#39;</span><span class="p">);</span>
		<span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">variables</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="s1">&#39;expected variables to be an object&#39;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">signatures</span> <span class="o">=</span> <span class="nx">functionValue</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\(.*?\)/g</span><span class="p">);</span>
		<span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nx">signatures</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">signature</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">signature</span> <span class="o">=</span> <span class="nx">signature</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\w+/g</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span> <span class="c1">//[&quot;string&quot;,&quot;unknown&quot;]</span>
			<span class="k">return</span> <span class="nx">signature</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">variables</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">signature</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Most of these types that the client sends up match the typeof values of the javascript
types themselves so we can do a direct comparison</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">case</span> <span class="s1">&#39;number&#39;</span><span class="o">:</span>
					<span class="k">case</span> <span class="s1">&#39;string&#39;</span><span class="o">:</span>
					<span class="k">case</span> <span class="s1">&#39;boolean&#39;</span><span class="o">:</span>
						<span class="k">return</span> <span class="k">typeof</span> <span class="nx">variables</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">===</span> <span class="nx">type</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>In the case of unknown, we have no choice but to trust the argument as
the client hasn't specified what type it should be</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">case</span> <span class="s1">&#39;unknown&#39;</span><span class="o">:</span>
						<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
					<span class="k">case</span> <span class="s1">&#39;array&#39;</span><span class="o">:</span>
						<span class="k">return</span> <span class="k">typeof</span> <span class="nx">variables</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">;</span>
					<span class="k">case</span> <span class="s1">&#39;dispatch&#39;</span><span class="o">:</span>
						<span class="k">return</span> <span class="k">typeof</span> <span class="nx">variables</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">variables</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">;</span>
				<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>has the client provided a type that we weren't expecting?</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">throw</span> <span class="s1">&#39;there is an invalid type in the function signature exposed by the client&#39;</span><span class="p">;</span>
			<span class="p">});</span>
		<span class="p">});</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Functions are simply urls that we make ajax request to. The cb is called with the
result of that ajax request.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">createFunction</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">signatures</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="s1">&#39;cannot create a function without a session id&#39;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">func</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">assert</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="s1">&#39;return value callback is not optional&#39;</span><span class="p">);</span>
			<span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="s1">&#39;the first argument must be a function that receives the return value for the call to the client&#39;</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Lets do a bit of validation of the arguments that we're passing into the client
unfortunately arguments isn't a completely authetic javascript array, so we'll have
to "splice" by hand. All this just to validate the correct types! sheesh...</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">native_args</span> <span class="o">=</span> <span class="p">[];</span>
			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">native_args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>This is as close to a static class function as you can get in javascript i guess
we should be able to use verifySignaturesArguments to determine if the client will
consider the arguments that we're passing to be valid</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">validateArguments</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">signatures</span><span class="p">,</span> <span class="nx">native_args</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">throw</span> <span class="s1">&#39;arguments do not match any of the function signatures exposed by the client&#39;</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>


			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>We are responsible for converting functions to variable names...
this will be called later via a event with a callback and arguments variables</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">storeCallbackFunction</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="nx">path</span> <span class="o">+=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">args</span><span class="p">));</span>
			<span class="nx">path</span> <span class="o">+=</span> <span class="s1">&#39;)/&#39;</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">path</span><span class="p">],</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;queries&#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
		<span class="p">},</span> <span class="k">this</span><span class="p">);</span>
		<span class="nx">func</span><span class="p">.</span><span class="nx">valueOf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">signatures</span><span class="p">;</span> <span class="p">};</span>
		<span class="k">return</span> <span class="nx">func</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">query</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">queries</span><span class="p">,</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;update&quot;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;state&quot;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="s1">&#39;the query type must be either &quot;update&quot;, &quot;state&quot;, or &quot;function&quot;&#39;</span><span class="p">);</span>
		<span class="nx">cb</span> <span class="o">=</span> <span class="nx">cb</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
		<span class="nx">err</span> <span class="o">=</span> <span class="nx">err</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Handle either an array of strings or just a single query.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">queries</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="nx">queries</span> <span class="o">=</span> <span class="p">[</span><span class="nx">queries</span><span class="p">];</span>

		<span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="nx">args</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">queries</span><span class="p">)</span> <span class="nx">args</span><span class="p">[</span><span class="s1">&#39;queries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">queries</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="nx">args</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">session</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">success_callback</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">==</span> <span class="s1">&#39;invalid request&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span> <span class="mi">1000</span><span class="p">);</span>
				<span class="k">throw</span> <span class="s1">&#39;pairing occured with a torrent client that does not support the btapp api&#39;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;error&#39;</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">err</span><span class="p">();</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">cb</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">},</span> <span class="k">this</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">send_query</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">success_callback</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h2>Falcon Torrent Client</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Falcon torrent client connections are a bit more involved than a client on the local machine
We have additional javascript dependencies that are substantial enough that we don't load them
unless you open a falcon connection. In addition we have some handshaking with the falcon proxy
that we need to wait for.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">FalconTorrentClient</span> <span class="o">=</span> <span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">);</span>
		
		<span class="nx">assert</span><span class="p">((</span><span class="s1">&#39;username&#39;</span> <span class="k">in</span> <span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;password&#39;</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;remote_data&#39;</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">,</span>
			<span class="s1">&#39;attempting to connect to client through falcon without providing the necessary credentials&#39;</span><span class="p">);</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">username</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;remote_data&#39;</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">remote_data</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">remote_data</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;login_success&#39;</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">login_success</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">login_success</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;login_error&#39;</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">login_error</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">login_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;login_progress&#39;</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">login_progress</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">login_progress</span><span class="p">;</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>We only have to load all those expensive js dependencies once...
We can just skip straight to the good stuff (signing in) if we've
done this previously...the last dependency we load sets the
window.falcon variable, so we can just check for that</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="nx">falcon</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">_</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If we choose to use falcon we need this specific global config variable defined</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nb">window</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
			<span class="nx">srp_root</span><span class="o">:</span><span class="s1">&#39;https://remote.utorrent.com&#39;</span>
		<span class="p">};</span>

		<span class="kd">var</span> <span class="nx">jsload</span> <span class="o">=</span> <span class="s1">&#39;https://remote.utorrent.com/static/js/jsloadv2.js?v=0.57&#39;</span><span class="p">;</span>
		<span class="nx">jQuery</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span><span class="nx">jsload</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">function</span> <span class="nx">create_tags</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="p">[];</span>
				<span class="kd">var</span> <span class="nx">deps</span> <span class="o">=</span> <span class="p">[];</span>
				<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
					<span class="nx">tags</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">current</span> <span class="p">}</span> <span class="p">);</span>
					<span class="nx">deps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">current</span> <span class="p">);</span>
				<span class="p">}</span>
				<span class="nx">tags</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">list</span><span class="p">[</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
				<span class="nx">requires</span><span class="o">:</span> <span class="nx">deps</span> <span class="p">}</span> <span class="p">);</span>
				<span class="k">return</span> <span class="nx">tags</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="nx">dependencies</span> <span class="o">=</span> <span class="p">[</span>
				<span class="s1">&#39;falcon/deps/SHA-1.js&#39;</span><span class="p">,</span>
				<span class="s1">&#39;falcon/deps/jsbn.js&#39;</span><span class="p">,</span>
				<span class="s1">&#39;falcon/deps/jsbn2.js&#39;</span><span class="p">,</span>
				<span class="s1">&#39;falcon/deps/sjcl.js&#39;</span><span class="p">,</span>
				<span class="s1">&#39;falcon/falcon.js&#39;</span><span class="p">,</span>
				<span class="s1">&#39;falcon/falcon.encryption.js&#39;</span><span class="p">,</span>
				<span class="s1">&#39;falcon/falcon.api.js&#39;</span><span class="p">,</span>
				<span class="s1">&#39;falcon/falcon.session.js&#39;</span>
			<span class="p">];</span>
			<span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="nx">create_tags</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">);</span>
			<span class="p">(</span><span class="k">new</span> <span class="nx">JSLoad</span><span class="p">(</span><span class="nx">tags</span><span class="p">,</span> <span class="s2">&quot;https://remote.utorrent.com/static/js/&quot;</span><span class="p">)).</span><span class="nx">load</span><span class="p">([</span><span class="s1">&#39;falcon/falcon.session.js&#39;</span><span class="p">],</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">remote_data</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">falcon</span><span class="p">.</span><span class="nx">session</span><span class="p">(</span> <span class="p">{</span> <span class="nx">client_data</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">remote_data</span> <span class="p">}</span> <span class="p">);</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">falcon</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">api</span><span class="p">;</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;client:connected&#39;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
				<span class="p">}</span>
			<span class="p">},</span> <span class="k">this</span><span class="p">));</span>
		<span class="p">},</span> <span class="k">this</span><span class="p">));</span>
	<span class="p">},</span>
	<span class="nx">connect</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">falcon</span><span class="p">,</span> <span class="s1">&#39;trying to connect with falcon already set&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>set up some connection variables</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span>
			<span class="nx">success</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">login_success</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">login_success</span><span class="p">(</span><span class="nx">session</span><span class="p">);</span> <span class="p">}</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">falcon</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">api</span><span class="p">;</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;client:connected&#39;</span><span class="p">);</span>
			<span class="p">},</span> <span class="k">this</span><span class="p">),</span>
			<span class="nx">error</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">login_error</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">login_error</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span> <span class="p">}</span>
			<span class="p">},</span> <span class="k">this</span><span class="p">)</span>
		<span class="p">};</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">falcon</span><span class="p">.</span><span class="nx">session</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">negotiate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="p">{</span> <span class="nx">success</span><span class="o">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">success</span><span class="p">,</span> <span class="nx">error</span><span class="o">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">error</span><span class="p">,</span> <span class="nx">progress</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">login_progress</span> <span class="p">}</span> <span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>This is the Btapp object's gateway to the actual client requests. These requests look slightly
different than those headed to a local client because they are encrypted.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">send_query</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">falcon</span><span class="p">,</span> <span class="s1">&#39;cannot send a query to the client without falcon properly connected&#39;</span><span class="p">);</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">falcon</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span>
			<span class="s1">&#39;POST&#39;</span><span class="p">,</span>
			<span class="s1">&#39;/client/gui/&#39;</span><span class="p">,</span>
			<span class="p">{</span><span class="s1">&#39;btapp&#39;</span><span class="o">:</span><span class="s1">&#39;backbone.btapp.js&#39;</span><span class="p">},</span>
			<span class="nx">args</span><span class="p">,</span>
			<span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">assert</span><span class="p">(</span><span class="s1">&#39;build&#39;</span> <span class="k">in</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;expected build information in the falcon response&#39;</span><span class="p">);</span>
				<span class="nx">assert</span><span class="p">(</span><span class="s1">&#39;result&#39;</span> <span class="k">in</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;expected result information in the falcon response&#39;</span><span class="p">);</span>
				<span class="nx">cb</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
			<span class="p">},</span>
			<span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
				<span class="nx">err</span><span class="p">();</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
			<span class="p">},</span> <span class="k">this</span><span class="p">),</span>
			<span class="p">{}</span>
		<span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">falcon</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h2>Local Torrent Client</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>For clients on the local machine very little setup is neeeded. We have a known port that
the client listens on, so we can just make requests to that. We can also immediately
consider ourselves "connected", which indicates that we're connected to the machine
(for falcon clients we may not ever reach the client even if it is logged into falcon)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">LocalTorrentClient</span> <span class="o">=</span> <span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">btapp</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">btapp</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">initialize_manager</span><span class="p">(</span><span class="nx">attributes</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">initialize_pairing</span><span class="p">(</span><span class="nx">attributes</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>We have a seperate object that is responsible for managing the browser
plugin and using that plugin to ensure that Torque is downloaded and
running on the local machine.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">initialize_manager</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>if we don't have what we need, fetch it and try again</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">BtappPluginManager</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">jQuery</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span>
				<span class="s1">&#39;http://apps.bittorrent.com/torque/btapp/plugin.btapp.js&#39;</span><span class="p">,</span>
				<span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">initialize_manager</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">)</span>
			<span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	
		<span class="nx">assert</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">BtappPluginManager</span><span class="p">,</span> <span class="s1">&#39;expected plugin.btapp.js to be loaded by now&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">manager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BtappPluginManager</span><span class="p">(</span><span class="nx">attributes</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">manager</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>We have a seperate object responsible for determining exactly which
port the torrent client is bound to.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">initialize_pairing</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>if we don't have what we need, fetch it and try again</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">Pairing</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">jQuery</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span>
				<span class="s1">&#39;http://apps.bittorrent.com/torque/btapp/pairing.btapp.js&#39;</span><span class="p">,</span>
				<span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">initialize_pairing</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">)</span>
			<span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>if we don't have what we need, fetch it and try again</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">jStorage</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">jQuery</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span>
				<span class="s1">&#39;http://apps.bittorrent.com/torque/jStorage/jstorage.min.js&#39;</span><span class="p">,</span>
				<span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">initialize_pairing</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">)</span>
			<span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>all right...ready to roll.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">pairing</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pairing</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">pairing</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">pairing</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;pairing:found&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">version</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">jStorage</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;pairing_key&#39;</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">options</span><span class="p">.</span><span class="nx">continue_scan</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
					<span class="nx">options</span><span class="p">.</span><span class="nx">attempt_authorization</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">connect_to_authenticated_port</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nx">options</span><span class="p">.</span><span class="nx">continue_scan</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
					<span class="nx">options</span><span class="p">.</span><span class="nx">attempt_authorization</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">},</span> <span class="k">this</span><span class="p">));</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">pairing</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;pairing:authorized&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">jQuery</span><span class="p">.</span><span class="nx">jStorage</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;pairing_key&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">connect_to_authenticated_port</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
		<span class="p">},</span> <span class="k">this</span><span class="p">));</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">pairing</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;pairing:nonefound&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">delayed_reset</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span> <span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
	<span class="p">},</span>
	<span class="nx">connect_to_authenticated_port</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">cb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.1:&#39;</span> <span class="o">+</span> <span class="nx">port</span> <span class="o">+</span> <span class="s1">&#39;/btapp/?pairing=&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;client:connected&#39;</span><span class="p">);</span>
		<span class="p">};</span>
		<span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">jQuery</span><span class="p">.</span><span class="nx">jStorage</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
		<span class="p">};</span>
	
		<span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
			<span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;http://127.0.0.1:&#39;</span> <span class="o">+</span> <span class="nx">port</span> <span class="o">+</span> <span class="s1">&#39;/btapp/?pairing=&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">,</span>
			<span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>
			<span class="nx">context</span><span class="o">:</span> <span class="k">this</span><span class="p">,</span>
			<span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;invalid request&#39;</span><span class="p">)</span> <span class="nx">err</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
				<span class="k">else</span> <span class="nx">cb</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
			<span class="p">},</span>
			<span class="nx">error</span><span class="o">:</span> <span class="nx">err</span>
		<span class="p">});</span>
	<span class="p">},</span>
	<span class="nx">delayed_reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">setTimeout</span><span class="p">(</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span> <span class="p">},</span> <span class="k">this</span><span class="p">),</span> <span class="mi">1000</span> <span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Reset is called upon initialization (or when we load pairing.btapp.js)
and whenever the btapp object errors out trying to communicate with the
torrent client. In both cases we probably need to scan through the ports
again as the torrent client won't necessarily be able to connect to the
same port when it is relaunched.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">pairing</span><span class="p">.</span><span class="nx">scan</span><span class="p">();</span>
	<span class="p">},</span>
	<span class="nx">send_query</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
			<span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
			<span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>
			<span class="nx">context</span><span class="o">:</span> <span class="k">this</span><span class="p">,</span>
			<span class="nx">data</span><span class="o">:</span> <span class="nx">args</span><span class="p">,</span>
			<span class="nx">success</span><span class="o">:</span> <span class="nx">cb</span><span class="p">,</span>
			<span class="nx">error</span><span class="o">:</span> <span class="nx">err</span><span class="p">,</span>
			<span class="nx">timeout</span><span class="o">:</span> <span class="mi">5000</span>
		<span class="p">});</span>
	<span class="p">}</span>
<span class="p">});</span>	

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 