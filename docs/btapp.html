<!DOCTYPE html>  <html> <head>   <title>btapp.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="btapp.html">                 btapp.js               </a>                                           <a class="source" href="client.btapp.html">                 client.btapp.js               </a>                                           <a class="source" href="pairing.btapp.html">                 pairing.btapp.js               </a>                                           <a class="source" href="plugin.btapp.html">                 plugin.btapp.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               btapp.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Btapp.js 4.2.1</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>(c) 2012 Patrick Williams, BitTorrent Inc.
Btapp may be freely distributed under the MIT license.
For all details and documentation:
http://pwmckenna.github.com/btapp</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Welcome to Btapp!</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>This should provide a clean javascript layer above the utorrent/bittorrent
webui layer (the web interface to a client). It is intended to abstract away
everything but the objects and the functions that can be called on them.
There's no need for someone writing    a web app that interacts with the client to
constantly be doing diffs to see what has changed. In addition, calling long specific
urls to call a single function on a torrent object is pretty painful, so I added
functions that dangle off of the objects (in the bt object) that will call the urls
that will achieve the desired effect and will also handle passing functions as arguments...
this is similar to soap or rpc...so callbacks should <em>just work</em>...in fact, we internally
rely on this as the    torrentStatus event function is set and the used to keep our models up to date</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>some of us are lost in the world without __asm int 3;
lets give ourselves an easy way to blow the world up if we're not happy about something</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">assert</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">b</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>BtappBase</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>BtappBase is <em>extend</em>-ed into both BtappModel and BtappCollection in the hopes of
reducing redundant code...both these types need a way to build up children elements
from data retrieved from the torrent client, as a way to clean that data up should
the client become unreachable.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">BtappBase</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;initializeValues&#39;</span><span class="p">,</span> <span class="s1">&#39;updateState&#39;</span><span class="p">,</span> <span class="s1">&#39;clearState&#39;</span><span class="p">,</span> <span class="s1">&#39;isEmpty&#39;</span><span class="p">,</span> <span class="s1">&#39;destructor&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">initializeValues</span><span class="p">();</span>
	<span class="p">},</span>
	<span class="nx">initializeValues</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">bt</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">updateState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">add</span><span class="p">,</span> <span class="nx">remove</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">isEmptyObject</span><span class="p">(</span><span class="nx">add</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">isEmptyObject</span><span class="p">(</span><span class="nx">remove</span><span class="p">),</span> <span class="s1">&#39;the client is outputing empty objects(&quot;&#39;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;&quot;)...these should have been trimmed off&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="nx">session</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>lets give our object the change to verify the url</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">verifyUrl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">),</span> <span class="s1">&#39;cannot updateState with an invalid collection url&#39;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="nx">add</span> <span class="o">=</span> <span class="nx">add</span> <span class="o">||</span> <span class="p">{};</span>
		<span class="nx">remove</span> <span class="o">=</span> <span class="nx">remove</span> <span class="o">||</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>We're going to iterate over both the added and removed diff trees
because elements that change exist in both trees, we won't delete
elements that exist in remove if they also exist in add...
As a nice verification step, we're also going to verify that the remove
diff tree contains the old value when we change it to the value in the add
diff tree. This should help ensure that we're completely up to date
and haven't missed any state dumps</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">updateAddState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">add</span><span class="p">,</span> <span class="nx">remove</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">updateRemoveState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">add</span><span class="p">,</span> <span class="nx">remove</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">clearState</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>we want to call clearState on all child elements</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">clearState</span> <span class="o">&amp;&amp;</span> <span class="nx">attribute</span><span class="p">.</span><span class="nx">clearState</span><span class="p">();</span> <span class="p">});</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">each</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span> <span class="nx">model</span><span class="p">.</span><span class="nx">clearState</span><span class="p">();</span> <span class="p">});</span>
	</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>once child elements have been cleared, just blow away our children elements</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">reset</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">clear</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
		
		<span class="k">this</span><span class="p">.</span><span class="nx">destructor</span><span class="p">();</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">initializeValues</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>BtappCollection</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>BtappCollection is a collection of objects in the client...
currently this can only be used to represent the list of torrents,
then within the torrents, their list of files...this will eventually
be used for rss feeds, etc as well.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">BtappCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">BtappBase</span><span class="p">).</span><span class="nx">extend</span><span class="p">({</span>
	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">models</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
		<span class="nx">BtappBase</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
		<span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;customAddEvent&#39;</span><span class="p">,</span> <span class="s1">&#39;customRemoveEvent&#39;</span><span class="p">,</span> <span class="s1">&#39;customChangeEvent&#39;</span><span class="p">);</span>
		
		<span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">customAddEvent</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">customRemoveEvent</span><span class="p">)</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">customChangeEvent</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">customAddEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;called a custom event without a valid attribute&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;add:&#39;</span> <span class="o">+</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">model</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">customRemoveEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;called a custom event without a valid attribute&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;remove:&#39;</span> <span class="o">+</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">model</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">customChangeEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;called a custom event without a valid attribute&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;change:&#39;</span> <span class="o">+</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">model</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">destructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">customAddEvent</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">customRemoveEvent</span><span class="p">)</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">customChangeEvent</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;destroy&#39;</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">verifyUrl</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/torrent\/$/</span><span class="p">)</span> <span class="o">||</span>
			<span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/torrent\/all\/[^\/]+\/file\/$/</span><span class="p">)</span> <span class="o">||</span>
			<span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/torrent\/all\/[^\/]+\/peer\/$/</span><span class="p">)</span> <span class="o">||</span>
			<span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/label\/$/</span><span class="p">)</span> <span class="o">||</span>
			<span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/label\/all\/[^\/]+\/torrent\/$/</span><span class="p">)</span> <span class="o">||</span>
			<span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/label\/all\/[^\/]+\/torrent\/all\/[^\/]+\/file\/$/</span><span class="p">)</span> <span class="o">||</span>
			<span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/label\/all\/[^\/]+\/torrent\/all\/[^\/]+\/peer\/$/</span><span class="p">)</span> <span class="o">||</span>
			<span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/rss_feed\/$/</span><span class="p">)</span> <span class="o">||</span>
			<span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/rss_feed\/all\/[^\/]+\/item\/$/</span><span class="p">)</span> <span class="o">||</span>
			<span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/rss_filter\/$/</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">updateRemoveObjectState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
		<span class="nx">assert</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;trying to remove a model that does not exist&#39;</span><span class="p">);</span>
		<span class="nx">assert</span><span class="p">(</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">BtappModel</span><span class="p">,</span> <span class="s1">&#39;trying to remove an object, but the existing value is not a model&#39;</span><span class="p">);</span>
		<span class="nx">model</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">updateRemoveFunctionState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="nx">v</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">,</span> <span class="s1">&#39;trying to remove a function that does not exist&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;remove:bt:&#39;</span> <span class="o">+</span> <span class="nx">v</span><span class="p">);</span>
		<span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span>
	<span class="p">},</span>
	<span class="nx">updateRemoveAttributeState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">removed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">throw</span> <span class="s1">&#39;trying to remove an invalid type from a BtappCollection&#39;</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">updateRemoveState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">add</span><span class="p">,</span> <span class="nx">remove</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Iterate over the diffs that came from the client to see what has been added (only in add),
removed (only in remove), or changed (old value in remove, new value in add)</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">uv</span> <span class="k">in</span> <span class="nx">remove</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="nx">add</span><span class="p">[</span><span class="nx">uv</span><span class="p">];</span>
			<span class="kd">var</span> <span class="nx">removed</span> <span class="o">=</span> <span class="nx">remove</span><span class="p">[</span><span class="nx">uv</span><span class="p">];</span>
			<span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">uv</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">childurl</span> <span class="o">=</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">v</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Elements that are in remove aren't necessarily being removed,
they might alternatively be the old value of a variable that has changed</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="nx">added</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Most native objects coming from the client have an "all" layer before their variables,
There is no need for the additional layer in javascript so we just flatten the tree a bit.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="nx">v</span> <span class="o">===</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>We only expect objects and functions to be added to collections</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">removed</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">updateRemoveObjectState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">removed</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isFunctionSignature</span><span class="p">(</span><span class="nx">removed</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">updateRemoveFunctionState</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">updateRemoveAttributeState</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">removed</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">updateAddObjectState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">model</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BtappModel</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="nx">v</span><span class="p">});</span>
			<span class="nx">model</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">childurl</span><span class="p">;</span>
			<span class="nx">model</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">;</span>
			<span class="nx">model</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">model</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">updateAddFunctionState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">v</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">),</span> <span class="s1">&#39;trying to add a function that already exists&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">createFunction</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">added</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;add:bt:&#39;</span> <span class="o">+</span> <span class="nx">v</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">updateAddAttributeState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">throw</span> <span class="s1">&#39;trying to add an invalid type to a BtappCollection&#39;</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">updateAddState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">add</span><span class="p">,</span> <span class="nx">remove</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">uv</span> <span class="k">in</span> <span class="nx">add</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="nx">add</span><span class="p">[</span><span class="nx">uv</span><span class="p">];</span>
			<span class="kd">var</span> <span class="nx">removed</span> <span class="o">=</span> <span class="nx">remove</span><span class="p">[</span><span class="nx">uv</span><span class="p">];</span>
			<span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">uv</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">childurl</span> <span class="o">=</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">v</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Most native objects coming from the client have an "all" layer before their variables,
There is no need for the additional layer in javascript so we just flatten the tree a bit.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="nx">v</span> <span class="o">===</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">added</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">updateAddObjectState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">added</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isFunctionSignature</span><span class="p">(</span><span class="nx">added</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">updateAddFunctionState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">updateAddAttributeState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">isEmpty</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isEmptyObject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h2>BtappModel</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>BtappModel is the base model for most things in the client
a torrent is a BtappModel, a file is a BtappModel, properties that
hang off of most BtappModels is also a BtappModel...both BtappModel
and BtappCollection objects are responsible for taking the json object
that is returned by the client and turning that into attributes/functions/etc</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">BtappModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">BtappBase</span><span class="p">).</span><span class="nx">extend</span><span class="p">({</span>
	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
		<span class="nx">BtappBase</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
		<span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;customEvents&#39;</span><span class="p">);</span>
		
		<span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">customEvents</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">destructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">customEvents</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;destroy&#39;</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">customEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">changedAttributes</span><span class="p">();</span>
		<span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>check if this is a value that has been unset</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">prev</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">previous</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="nx">prev</span><span class="p">);</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;remove:&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">prev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">previous</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;add:&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">},</span> <span class="k">this</span><span class="p">));</span>
	<span class="p">},</span>
	<span class="nx">verifyUrl</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">updateRemoveObjectState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Update state downstream from here. Then remove from the collection.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
		<span class="nx">assert</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;trying to remove a model that does not exist&#39;</span><span class="p">);</span>
		<span class="nx">assert</span><span class="p">(</span><span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">BtappModel</span> <span class="o">||</span> <span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">BtappCollection</span><span class="p">,</span> <span class="s1">&#39;expected removed attribute to be an instance of BtappModel or BtappCollection&#39;</span><span class="p">);</span>
		<span class="nx">model</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">())</span> <span class="p">{</span>
			<span class="nx">attributes</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">updateRemoveFunctionState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="nx">v</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">,</span> <span class="s1">&#39;trying to remove a function that does not exist&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;remove:bt:&#39;</span> <span class="o">+</span> <span class="nx">v</span><span class="p">);</span>
		<span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span>
	<span class="p">},</span>
	<span class="nx">updateRemoveAttributeState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">removed</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">removed</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">?</span> <span class="nx">unescape</span><span class="p">(</span><span class="nx">removed</span><span class="p">)</span> <span class="o">:</span> <span class="nx">removed</span><span class="p">;</span>
		<span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">===</span> <span class="nx">removed</span><span class="p">,</span> <span class="s1">&#39;trying to remove an attribute, but did not provide the correct previous value&#39;</span><span class="p">);</span>
		<span class="nx">attributes</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">updateRemoveState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">add</span><span class="p">,</span> <span class="nx">remove</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">uv</span> <span class="k">in</span> <span class="nx">remove</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="nx">add</span><span class="p">[</span><span class="nx">uv</span><span class="p">];</span>
			<span class="kd">var</span> <span class="nx">removed</span> <span class="o">=</span> <span class="nx">remove</span><span class="p">[</span><span class="nx">uv</span><span class="p">];</span>
			<span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">uv</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">childurl</span> <span class="o">=</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">v</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="nx">added</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>special case all</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="nx">v</span> <span class="o">===</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">removed</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">updateRemoveObjectState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">removed</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isFunctionSignature</span><span class="p">(</span><span class="nx">removed</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">updateRemoveFunctionState</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">v</span> <span class="o">!=</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">updateRemoveAttributeState</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;unset&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
	<span class="p">},</span>
	<span class="nx">updateAddObjectState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Don't recreate a variable we already have. Just update it.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="nx">model</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>This is the only hard coding that we should do in this library...
As a convenience, torrents and their file/peer lists are treated as backbone collections
the same is true of rss_feeds and filters...its just a more intuitive way of using them</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="nx">BtappCollection</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">verifyUrl</span><span class="p">(</span><span class="nx">childurl</span><span class="p">))</span> <span class="p">{</span>
				<span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BtappCollection</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BtappModel</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="nx">v</span><span class="p">});</span>
			<span class="p">}</span>
			<span class="nx">model</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">childurl</span><span class="p">;</span>
			<span class="nx">model</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">;</span>
			<span class="nx">attributes</span><span class="p">[</span><span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nx">model</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">updateAddFunctionState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">v</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">),</span> <span class="s1">&#39;trying to add a function that already exists&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">createFunction</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">added</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;add:bt:&#39;</span> <span class="o">+</span> <span class="nx">v</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">updateAddAttributeState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Set non function/object variables as model attributes</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">added</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">added</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">unescape</span><span class="p">(</span><span class="nx">added</span><span class="p">)</span> <span class="o">:</span> <span class="nx">added</span><span class="p">;</span>
		<span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span> <span class="o">===</span> <span class="nx">added</span><span class="p">),</span> <span class="s1">&#39;trying to set a variable to the existing value [&#39;</span> <span class="o">+</span> <span class="nx">childurl</span> <span class="o">+</span> <span class="s1">&#39; -&gt; &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">added</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">removed</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">))</span> <span class="p">{</span>
			<span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">))</span> <span class="o">===</span> <span class="nx">removed</span><span class="p">,</span> <span class="s1">&#39;trying to update an attribute, but did not provide the correct previous value&#39;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="nx">attributes</span><span class="p">[</span><span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">added</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">updateAddState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">add</span><span class="p">,</span> <span class="nx">remove</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">attributes</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">uv</span> <span class="k">in</span> <span class="nx">add</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="nx">add</span><span class="p">[</span><span class="nx">uv</span><span class="p">];</span>
			<span class="kd">var</span> <span class="nx">removed</span> <span class="o">=</span> <span class="nx">remove</span><span class="p">[</span><span class="nx">uv</span><span class="p">];</span>
			<span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">uv</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">childurl</span> <span class="o">=</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">v</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Special case all. It is a redundant layer that exist for the benefit of the torrent client</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="nx">v</span> <span class="o">===</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">added</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">updateAddObjectState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">added</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isFunctionSignature</span><span class="p">(</span><span class="nx">added</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">updateAddFunctionState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">updateAddAttributeState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">childurl</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">);</span>
			<span class="p">}</span>	
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">attributes</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">isEmpty</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
		<span class="k">return</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">isEmptyObject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;id&#39;</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h2>Btapp</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Btapp is the root of the client objects' tree, and generally the only object that clients should instantiate.
This mirrors the original api where document.btapp was the root of everything. generally, this api attempts to be
as similar as possible to that one...</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>BEFORE:
<em>btapp.torrent.get('XXX').file.get('XXX').properties.get('name');</em>
AFTER:
<em>btapp.get('torrent').get('XXX').get('file').get('XXX').get('properties').get('name');</em></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>The primary difference is that in the original you got the state at that exact moment, where
we now simply keep the backbone objects up to date (by quick polling and updating as diffs are returned)
so you can query at your leisure.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nx">Btapp</span> <span class="o">=</span> <span class="nx">BtappModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
	<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">BtappModel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>

		<span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;btapp/&#39;</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">connected_state</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>bind stuff</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="s1">&#39;connected&#39;</span><span class="p">,</span> <span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="s1">&#39;onEvents&#39;</span><span class="p">,</span> <span class="s1">&#39;onFetch&#39;</span><span class="p">,</span> <span class="s1">&#39;onConnectionError&#39;</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">destructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>We don't want to destruct the base object even when we can't connect...
Its event bindings are the only way we'll known when we've re-connected
WARNING: this might leak a wee bit if you have numerous connections in your app</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="p">},</span>
	<span class="nx">connect</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="s1">&#39;trying to connect to an undefined client&#39;</span><span class="p">);</span>
		<span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">connected_state</span><span class="p">,</span> <span class="s1">&#39;trying to connect when already connected&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">connected_state</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Initialize variables</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">attributes</span> <span class="o">=</span> <span class="nx">attributes</span> <span class="o">||</span> <span class="p">{};</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">poll_frequency</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">poll_frequency</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">queries</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">queries</span> <span class="o">||</span> <span class="nx">Btapp</span><span class="p">.</span><span class="nx">QUERIES</span><span class="p">.</span><span class="nx">ALL</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>At this point, if a username password combo is provided we assume that we're trying to
access a falcon client. If not, default to the client running on your local machine.
You can also pass in "remote_data" that is returned from a falcon.serialize()</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">attributes</span><span class="p">.</span><span class="nx">btapp</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>We'll check for TorrentClient and assume that FalconTorrentClient and LocalTorrentClient
come along for the ride.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">TorrentClient</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">setClient</span><span class="p">(</span><span class="nx">attributes</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">jQuery</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span>
				<span class="s1">&#39;http://apps.bittorrent.com/torque/btapp/client.btapp.js&#39;</span><span class="p">,</span>
			<span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">setClient</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">)</span>
			<span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">setClient</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="s1">&#39;username&#39;</span> <span class="k">in</span> <span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;password&#39;</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;remote_data&#39;</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FalconTorrentClient</span><span class="p">(</span><span class="nx">attributes</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalTorrentClient</span><span class="p">(</span><span class="nx">attributes</span><span class="p">);</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>While we don't want app writers having to interact with the client directly,
it would be nice to be able to listen in on what's going on...so lets just bubble
them up as client:XXX messages</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;client:connected&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fetch</span><span class="p">);</span>		
	<span class="p">},</span>
	<span class="nx">disconnect</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="s1">&#39;trying to disconnect from an undefined client&#39;</span><span class="p">);</span>
		<span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected_state</span><span class="p">,</span> <span class="s1">&#39;trying to disconnect when not connected&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">connected_state</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">next_timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">clearTimeout</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">next_timeout</span> <span class="p">);</span>
		<span class="p">}</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">btapp</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">clearState</span><span class="p">();</span>
	<span class="p">},</span>
	<span class="nx">connected</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">connected_state</span><span class="p">;</span>
	<span class="p">},</span>
	<span class="nx">onConnectionError</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">clearState</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">onFetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">assert</span><span class="p">(</span><span class="s1">&#39;session&#39;</span> <span class="k">in</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;did not recieve a session id from the client&#39;</span><span class="p">);</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">waitForEvents</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">session</span><span class="p">);</span>
	<span class="p">},</span>
	<span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">queries</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onFetch</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onConnectionError</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">onEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;sync&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>There are two types of events...state updates and callbacks
Handle state updates the same way we handle the initial tree building</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="s1">&#39;add&#39;</span> <span class="k">in</span> <span class="nx">data</span> <span class="o">||</span> <span class="s1">&#39;remove&#39;</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">data</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">add</span> <span class="o">||</span> <span class="p">{};</span>
			<span class="nx">data</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">remove</span> <span class="o">||</span> <span class="p">{};</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">add</span><span class="p">.</span><span class="nx">btapp</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">remove</span><span class="p">.</span><span class="nx">btapp</span><span class="p">,</span> <span class="s1">&#39;btapp/&#39;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s1">&#39;callback&#39;</span> <span class="k">in</span> <span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;arguments&#39;</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">btappCallbacks</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">callback</span><span class="p">](</span><span class="nx">data</span><span class="p">.</span><span class="nx">arguments</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">throw</span> <span class="s1">&#39;received invalid data from the client&#39;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>When we get a poll response from the client, we sort through them here, as well as track round trip time.
We also don't fire off another poll request until we've finished up here, so we don't overload the client if
it is generating a large diff tree. We should generally on get one element in data array. Anything more and
the client has wasted energy creating seperate diff trees.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">onEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">onEvent</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">next_timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">waitForEvents</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">session</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">poll_frequency</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="nx">waitForEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onEvents</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">(),</span> <span class="nx">session</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">onConnectionError</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>The version of this library should always match the version of torque that it requires.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Btapp</span><span class="p">.</span><span class="nx">VERSION</span> <span class="o">=</span> <span class="s1">&#39;4.2.1&#39;</span>
<span class="nx">Btapp</span><span class="p">.</span><span class="nx">QUERIES</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nx">ALL</span><span class="o">:</span> <span class="s1">&#39;btapp/&#39;</span><span class="p">,</span>
	<span class="nx">TORRENTS</span><span class="o">:</span> <span class="s1">&#39;btapp/torrent/all/*/&#39;</span><span class="p">,</span>
	<span class="nx">FILES</span><span class="o">:</span> <span class="s1">&#39;btapp/torrent/all/*/file/all/*/&#39;</span><span class="p">,</span>
	<span class="nx">PEERS</span><span class="o">:</span> <span class="s1">&#39;btapp/torrent/all/*/peer/all/*/&#39;</span><span class="p">,</span>
	<span class="nx">SETTINGS</span><span class="o">:</span> <span class="s1">&#39;btapp/settings/all/*/&#39;</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 